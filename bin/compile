#!/bin/sh

BUILD_DIR=$1
CACHE_DIR=$2


# midi->wavへ変換する依存ライブラリlibsndfileをインストール(通常はRAW PCMファイルへのレンダリングのみサポート)
LIBSND_SRC_DIR=/tmp/libsnd
mkdir -p $LIBSND_SRC_DIR

echo "-----> Installing libsndfile"
SND_URL="http://www.mega-nerd.com/libsndfile/files/libsndfile-1.0.28.tar.gz"
curl -L $SND_URL | tar xz -C $LIBSND_SRC_DIR --strip-components=1


LIBSND_BUILD_DIR=/tmp/libsnd/build
mkdir -p $LIBSND_BUILD_DIR

cd $LIBSND_BUILD_DIR || exit
../configure
make
make install

echo "-----> libsndfile installation complete"


# fluidsynthをインストール
echo "-----> Installing Fluidsynth"

# FLUIDSYNTH_VERSION="2.3.5"
FLUIDSYNTH_SRC_DIR=/tmp/fluidsynth
FLUIDSYNTH_VERSION="2.1.7"
FLUIDSYNTH_URL="https://github.com/FluidSynth/fluidsynth/archive/refs/tags/v$FLUIDSYNTH_VERSION.tar.gz"

mkdir -p $FLUIDSYNTH_SRC_DIR
curl -L $FLUIDSYNTH_URL | tar xz -C $FLUIDSYNTH_SRC_DIR --strip-components=1

# Build and install Fluidsynth
FLUIDSYNTH_BUILD_DIR=$FLUIDSYNTH_SRC_DIR/build
mkdir $FLUIDSYNTH_BUILD_DIR

FLUIDSYNTH_DIR=$BUILD_DIR/vendor/fluidsynth
mkdir -p $FLUIDSYNTH_DIR

cd $FLUIDSYNTH_BUILD_DIR || exit
cmake .. -Denable-libsndfile=ON 
make
make install DESTDIR=$FLUIDSYNTH_DIR

# Move the installed files to a standard location
# mv $FLUIDSYNTH_DIR/usr/local/* $FLUIDSYNTH_DIR/
# mv $FLUIDSYNTH_DIR/lib/* $FLUIDSYNTH_DIR/bin/

# Add the Fluidsynth binaries to the PATH
mkdir -p $BUILD_DIR/.profile.d
echo "export PATH=\$PATH:$HOME/vendor/fluidsynth/usr/local/bin" > $BUILD_DIR/.profile.d/fluidsynth.sh
echo "export LD_LIBRARY_PATH=\$LD_LIBRARY_PATH:$HOME/vendor/fluidsynth/usr/local/lib" >> $BUILD_DIR/.profile.d/fluidsynth.sh
echo "export LD_LIBRARY_PATH=\$LD_LIBRARY_PATH:$HOME/vendor/fluidsynth/usr/local/lib64" >> $BUILD_DIR/.profile.d/fluidsynth.sh

echo "-----> Fluidsynth installation complete"
